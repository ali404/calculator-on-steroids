var CalculatorApp={};!function($,window,document,undefined){CalculatorApp=function(){var App=function(){var t=function(){var t=io.connect("http://localhost:3000");$(".share-func").on("click",function(e){e.preventDefault();var n=$(this).parent().attr("id"),r={name:n};console.log("entered"),$.post("/shareFunction",r,function(e){"transaction complete"===e.message?(console.log("Transaction complete, function added to shared functions"),t.emit("share function",e.data)):"Error while fetching the functions"===e.message?console.log("Error occured, probably somebody changed from console.log smthing"):"No user logged in"===e.message&&console.log("No user logged in, this is weird. Check your code again main")})}),t.on("share function",function(t){$("#shared-functions").append("<div><h3>"+t.name+"</h3><p>"+t.originalAuthor+"</p><p>"+t.body+"</p><p>"+t.stars+"</p><hr></div>")})};return{init:t}}(),Calculus=function(){function CalculatorError(t,e){this.type=t,this.message=e,this.pushLog({type:e})}function getDecimals(t){var e=(""+t).match(/(?:\.(\d+))?(?:[eE]([+-]?\d+))?$/);return e?Math.max(0,(e[1]?e[1].length:0)-(e[2]?+e[2]:0)):0}CalculatorError.prototype.log=[],CalculatorError.prototype.pushLog=function(t){this.log.push(t)},Math.ln=function(t){return Math.log1p(t)},Math.deg={},Math.deg.sin=function(t){var e=Math.PI/180;return Math.sin(t*e)},Math.deg.cos=function(t){return Math.cos(t*Math.PI/180)},Math.deg.tan=function(t){return Math.tan(t*Math.PI/180)},Math.roundf=function(t,e){getDecimals(t)<e&&(e=getDecimals(t));for(var n=1,r=1;e>=r;r++)n*=10;return Math.round(t*n)/n},Math.roundSqrt=function(t){return Math.roundf(Math.sqrt(t),5)};var calcWithRadians=!1,cache=[{value:!1}],cacheIndex=1,computed=[],regex={multiply:/(x)/,ln:/((ln)\(\w+\))/,log:/((log)\(\w+\))/,trig:/(sin|cos|tan)/,euler:/(e)/,operations:/(x|\-|\+)/,functions:"(sin|cos|tan|ln|log)",helper:"([0-9]*(\\.?[0-9]+)+)|(x|\\-|\\+)|((e){1})|(\\()|(\\))",userFunctions:[]};regex.fullString="("+regex.functions+")|"+regex.helper,regex.fullStringRegex=new RegExp(regex.fullString);var stripInput=function(t){return t.replace(/\s+/g,"")},addComputed=function(t,e,n){n=n||[],computed[++t]={value:!1,isOperation:!1,isOpenBracket:!1,isClosedBracket:!1,isFunc:!1,isSymbol:!1},computed[t].value=e;for(var r=0;r<n.length;r++)computed[t][n[r]]=!0},calcComputedArray=function(t){for(var e=-1,n=[],r=0,i=0;0!==t.length;){for(;"π"==t[0]||"÷"==t[0]||"√"==t[0]||","==t[0];)"π"==t[0]?(addComputed(e,"pi",["isNumber","isSymbol"]),e++,t=t.slice(1)):"÷"==t[0]?(addComputed(e,"divide",["isOperation"]),e++,t=t.slice(1)):"√"==t[0]?(addComputed(e,"sqrt",["isFunc","isSymbol"]),e++,t=t.slice(1)):","==t[0]&&(addComputed(e,",",["isOperation"]),e++,t=t.slice(1));if(n=regex.fullStringRegex.exec(t),null!==n){if(0!==n.index)throw new CalculatorError("fatal error","input contains invalid charachters");addComputed(e,n[0]),e++,t=t.slice(n[0].length),"("==computed[e].value?computed[e].isOpenBracket=!0:")"==computed[e].value?computed[e].isClosedBracket=!0:computed[e].value.match(regex.operations)?computed[e].isOperation=!0:computed[e].value.match(regex.functions)?computed[e].isFunc=!0:computed[e].isNumber=!0}if(i==t.length?r++:(i=t.length,r=0),5===r)throw new CalculatorError("fatal error","input contains invalid charachters")}return computed},calcEvalArray=function(t){var e=[],n=t.length,r=!1,i=0,o=0;if(t[0].isOperation)throw new CalculatorError("fatal error","string beggining with an operation");if(t[n-1].isOperation)throw new CalculatorError("invalid syntax","string ending with an operation");e.push(t[0].value);for(var a=1;n>a;a++){if(t[a].isOpenBracket?i++:t[a].isClosedBracket&&o++,t[a].isOperation&&t[a-1].isOperation)throw new CalculatorError("fatal error","two operations one after another");if(t[a].isFunc&&(!t[a+1]||t[a+1].isOpenBracket!==!0))throw new CalculatorError("invalid syntax","function not preceeded by open bracket");(t[a].isOpenBracket&&(t[a-1].isNumber||t[a-1].isClosedBracket)||t[a-1].isClosedBracket&&(t[a].isNumber||t[a].isFunc)||t[a].isFunc&&t[a-1].isNumber||t[a].isSymbol&&(t[a-1].isSymbol||t[a-1].isNumber)||t[a].isNumber&&t[a-1].isSymbol)&&(e.push("x"),e.push(t[a].value),r=!0),r===!1&&e.push(t[a].value),r=!1}if(o>i)throw new CalculatorError("fatal error","closed brackets more than open brackets? why?");for(a=1;i-o>=a;a++)e.push(")");return e},computeEvalArray=function(t){for(var e,n="",r=0,i=t.length;i>r;r++){e=!1;for(var o in regex.userFunctions)if(t[r].match(regex.userFunctions[o])){n+=t[r],e=!0;break}t[r].match(regex.multiply)?n+="*":"divide"==t[r]?n+="/":"sqrt"==t[r]?n+="Math.roundSqrt":","==t[r]?n+=",":t[r].match(regex.trig)?(n+="Math.",0==calcWithRadians&&(n+="deg."),n+=t[r]):t[r].match(regex.euler)?n+=Math.E:"pi"==t[r]?n+=Math.PI:e===!1&&(n+=t[r])}return n},_calculateResult=function(input,optionalInput){var computedArray=[],evalArray=[],evalString="",result,isString="string"==typeof input;isString?input=stripInput(input):(computedArray=input,input=optionalInput);var a=isInArray(cache,input);if(a)return void $("#input-rez").text(cache[a].inputValue);if(""==input)return void $("#input-rez").text("");try{if(isString&&(computedArray=calcComputedArray(input),computed=[]),evalArray=calcEvalArray(computedArray),evalString=computeEvalArray(evalArray),result=eval(evalString),isNaN(result)){if(computedArray.pop(),0==computedArray.length)return void $("#input-rez").text("");_calculateResult(computedArray,input)}else result=Math.roundf(result,numberOfDecimals),isInArray(cache,input)||(cache[cacheIndex++]={value:input,inputValue:result}),$("#input-rez").text(result)}catch(err){if(err instanceof SyntaxError)return $("#input-rez").text("error"),void console.log(err);if(err instanceof CalculatorError){if("fatal error"===err.type)return $("#input-rez").text("error"),void console.log(err);"invalid syntax"===err.type&&(computedArray.pop(),_calculateResult(computedArray,input))}}},endCalculation=function(){var t=$("#input-rez");return"error"===t.text()?(raiseErrorAtInput(".input"),void setTimeout(function(){normaliseInput(".input")},2e3)):($("#input").css("visibility","hidden"),t.css("position","absolute").css("color","#000"),void t.animate({"font-size":"46px","margin-top":"-65px"},300,function(){$("#input").text(t.text()).removeAttr("style"),t.removeAttr("style").text("")}))},_reflowFontSize=function(t){var e=t.text().length,n="";n=e>40?"16px":e>20?"24px":e>10?"36px":"46px",$("#input").css("font-size",n)},numberOfDecimals=5,isInt=function(t){return/^[0-9]+[0-9]*$/.test(t)},isInArray=function(t,e){for(var n=0;n<t.length;n++)if(t[n].value==e)return n;return!1},raiseErrorAtInput=function(t){$(t).css("box-shadow","0px 0px 10px 0px #E81D62").css("border","1px solid #E81D62")},normaliseInput=function(t){$(t).css("box-shadow","0px 0px 10px 0px rgba(0,0,0,0.27)").css("border","1px solid #BCBCBC")},proccessInput=function(t){return""===t?(numberOfDecimals=5,void normaliseInput("#add-rounding")):isInt(t)?("0"==t[0]&&(t=t.slice(1)),normaliseInput("#add-rounding"),void(numberOfDecimals=+t)):void raiseErrorAtInput("#add-rounding")},eventHandlers={normalBtn:function(t){var e=$("#input").text()+t.text();$("#input").text(e)},deleteBtn:function(){var t=$("#input").text().slice(0,-1);$("#input").text(t)},deleteAllBtn:function(){var t;$("#terminate").on("mouseup",function(){return clearTimeout(t),!1}).on("mousedown",function(){return t=window.setTimeout(function(){$("#input").text("")},1e3),!1})},paranthesisBtn:function(t){var e=$("#input").text()+t.text()+"(";$("#input").text(e)}},_loadHandlers=function(){$("#input").on("keydown",function(t){return 13==t.keyCode?(endCalculation(),!1):void 0});var t=0;$("#input").on("keyup",function(e){var n=$(this);n.text().length!==t&&(t=n.text().length,_calculateResult($(this).text()),_reflowFontSize($(this)))}),$(".normal").on("click",function(){var t=$("#input");eventHandlers.normalBtn($(this)),_reflowFontSize(t),_calculateResult(t.text())}),$("#end-calc").on("click",function(){_calculateResult($("#input").text()),endCalculation()}),$(document).on("click",".double",function(){var t=$("#input");eventHandlers.paranthesisBtn($(this)),_reflowFontSize($("#input")),_calculateResult(t.text())}),$("#terminate").on("click",function(){eventHandlers.deleteBtn(),_calculateResult($("#input").text())}),$("#add-rounding").on("keyup",function(t){proccessInput($(this).text())}),eventHandlers.deleteAllBtn()},init=function(){_loadHandlers()};return{init:init,calcWithRadians:calcWithRadians,regex:regex,raiseErrorAtInput:raiseErrorAtInput,normaliseInput:normaliseInput}}(),Function=function(){var classes={name:"#func-name",func:"#func-code",button:"#func-btn"},funcNamesRegex=[],addFunction=function(t,e){var n="var "+e+"="+t+";",r={name:e,body:t,fullBody:n};$.post("/api/function/add",r,function(t){"Transaction complete"===t&&(addFuncRegex(e),addButton(e),addScript(n),console.log("success transaction"))})},addFuncRegex=function(t){Calculus.regex.functions=Calculus.regex.functions.slice(0,-1)+"|"+t+")",Calculus.regex.fullString="("+Calculus.regex.functions+")|"+Calculus.regex.helper,Calculus.regex.userFunctions.push(t),Calculus.regex.fullStringRegex=new RegExp(Calculus.regex.fullString)},addScript=function(t){$("body").append('<script class="script">'+t+"</script>")},addButton=function(t){$(".user-btns").append('<div class="user-btn double" data-name="'+t+'">'+t+"</div>")},_btnClickHandler=function(){var funcBody=$(classes.func).text(),name=$(classes.name).text(),hasErrors=!1;try{eval("var x = "+funcBody.toString())}catch(err){hasErrors=!0,console.log(err),console.log(funcBody)}return/\W/.test(name)||0===name.length?(hasErrors&&Calculus.raiseErrorAtInput(classes.func),Calculus.raiseErrorAtInput(classes.name),void(hasErrors?setTimeout(function(){$(classes.name).removeAttr("style"),$(classes.func).removeAttr("style")},2e3):setTimeout(function(){$(classes.name).removeAttr("style")},2e3))):hasErrors?(Calculus.raiseErrorAtInput(classes.func),void setTimeout(function(){$(classes.func).removeAttr("style")},2e3)):void addFunction(funcBody,name)},_changeTrig=function(t){t.hasClass("trig-active")||(t.hasClass("deg")?($(".deg").addClass("trig-active"),$(".rad").removeClass("trig-active"),Calculus.calcWithRadians=!1):($(".rad").addClass("trig-active"),$(".deg").removeClass("trig-active"),Calculus.calcWithRadians=!0))},loadFunctions=function(){$.get("/api/function/get",function(t){return"No user logged in"===t?void console.log("local session, no functions to fetch..."):(console.log("fetching functions..."),t&&t.forEach(function(t){addFuncRegex(t.name),addButton(t.name),addScript(t.fullBody)}),void console.log("fetching functions done"))})},init=function(){$(classes.button).bind("click",_btnClickHandler),$(".trig").on("click",function(){a,_changeTrig($(this))}),loadFunctions()};return{init:init,funcNamesRegex:funcNamesRegex}}(),Unit=function(){var t=[],e=function(t,e,r){var i="behaviour";r&&(i="result");var o=e();"result"==i&&r==o&&n({success:"true",date:Object.timestamp(),statement:t})},n=function(e){t.push(e),console.log("======== unit test no."+t.length),console.log(e),console.log("========================")};return{it:e,log:t}}(),init=function(){Function.init(),Calculus.init(),App.init()};return{init:init}}()}(jQuery,window,window.document),CalculatorApp.init();